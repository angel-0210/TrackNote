name: Build Release APK

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # allow workflow to push commits

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Restore google-services.json
        run: |
          mkdir -p app
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > app/google-services.json

      - name: Restore release keystore
        run: |
          mkdir -p app/keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/keystore/my-release-key.jks

      - name: Grant execute permission
        run: chmod +x ./gradlew

      - name: Build signed release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      # -----------------------------
      # Extract version info
      # -----------------------------
      - name: Read version info
        id: version
        run: |
          VERSION_CODE=$(grep versionCode app/build.gradle.kts | head -1 | sed 's/[^0-9]*//g')
          VERSION_NAME=$(grep versionName app/build.gradle.kts | head -1 | cut -d '"' -f2)

          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT

      # -----------------------------
      # Update update.json
      # -----------------------------
      - name: Update update.json
        run: |
          jq \
            --arg vc "${{ steps.version.outputs.versionCode }}" \
            --arg vn "${{ steps.version.outputs.versionName }}" \
            --arg url "https://your-domain.com/app-release.apk" \
            --arg log "New release ${{ steps.version.outputs.versionName }}" \
            '.versionCode=($vc|tonumber) |
             .versionName=$vn |
             .apkUrl=$url |
             .changelog=$log' \
            app/update.json > tmp.json && mv tmp.json app/update.json

      # -----------------------------
      # Commit update.json
      # -----------------------------
      - name: Commit update.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add app/update.json
          git commit -m "Update update.json for release" || echo "No changes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

      # -----------------------------
      # Upload APK
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.versionName }}
          name: TrackNote v${{ steps.version.outputs.versionName }}
          files: app/build/outputs/apk/release/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
